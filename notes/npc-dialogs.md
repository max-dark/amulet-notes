# Диалоги с NPC

Некоторые NPC имеют возможность общения с игроком.
Определяется по наличию файла `speak/$npsId`

## Формат файла диалога `speak/$npsId`

```php
<?php
return [
    'begin'   => 'title 0#answer 1#nextId1#answer 2#nextId2',
    'nextID1' => 'title 1#answer 3#begin#answer 4#nextID2',
    'nextID2' => 'title 2',
];
```

* Файл диалога - php файл с ассоциативным массивом.
* Ключи массива - ID темы.
* начальная тема - `begin`
* Значения содержат реплику NPC и варианты ответов пользователя.

По принципу работы очень похоже на "State machine"

## Формат элемента диалога

* тип: строка
* Разделитель полей: `#`
* Элемент диалога состоит из:
    * ID элемента
    * title - заголовка(реплики NPC)
    * списка вариантов ответов(элемент без списка ответов завершает диалог)

Варианты ответа состоят из реплики пользователя и следующего ID в диалоге - ответа NPC.

Реплики, начинающиеся с `eval:` - php-скрипты и обрабатываются через функцию `eval`.

Такие вставки мешают изменению во всем коде, так как:
* содержат обращение к глобальным переменным
* много "Copy-Paste"
* их трудно изменять.

Подстроки `<name>` заменяются на имя персонажа пользователя.

## Торговля с NPC

Торговцем считается NPC, у которго в ID тем разговора есть `buy` или `sell`

### Покупка товаров у NPC

У "продавца" в диалоге должна присутствовать тема с ID `buy`, предметы берутся из `$npc['bank']`

содержит ставку NPC и период обновления товаров

```php
list($cost, $period) = explode('|', $dialog['buy']);
```

### Продажа товаров NPC

У "скупщика" в диалоге должна присутствовать тема с ID `sell`

содержит ставку NPC и фильтр "интересных для NPC" товаров

```php
list($cost, $filter) = explode('|', $dialog['sell']);
$filter = explode(':', $filter);
```
Фильтр может:
* быть пустым("интересуют все виды товаров")
* содержать подстроки ID предметов(например, 'i.w.' - интересует оружие)

## Управление предметавми в "банке"

Банк - хранилище предметов.

Для управления содержимым банка нужно поговорить с NPC-банкиром.

Банкиром считается NPC, имеющий в диалоге непустую тему разговора `bank`.

## Изучение умений и управление характеристиками.

Есть несколько NPC, позволяющих изучать умения(приемы/заклинания) либо повышать характеристики персонажа.

NPC может обучать, если заголовок выбранной темы начинается с `skill`
```php
$tmp   = explode("|", $title);
$skillId = $tmp[1]; // ID умения/характеристики
$cost    = $tmp[2]; // стоимость обучения
$minLvl  = $tmp[3]; // минимальный уровень характеристики, с которого обучает NPC
$maxLvl  = $tmp[4]; // максимальный уровень характеристики, до которого обучает NPC
```
При привышении определенного уровня умений предлагается понизить какую нибудь характеристику.
