# Структура "Локация"

## Описания форматов данных в переменных

Локация - это ассоциативный массив, содержащий её описание, списки таймеров и объектов

ID текущей локации обычно хранится в глобальной переменной `$loc`

Локация может иметь текстовое описание в файле `loc_f/$loc`

В движке используется три глобальных массива с локациями:
* `$loc_tt[]` - список загруженных локаций
* `$loc_t[$loc]` - таймеры. берется из `$loc_tt[$loc]['t']`
* `$loc_i[$loc]` - объекты(игроки, НПС и предметы). берется из `$loc_tt[$loc]['i']`

Иногда используется четвертый - `$loc_c` - описание и список переходов. берется из `$loc_tt[$loc]['d']`

### поля структуры

* `d` - строка, содержит название, тип територии и список переходов в соседние
* `i` - массив, список объектов
* `t` - массив, список таймеров

```php
// пример структуры $loc_tt[$loc]
[
    // название локации|тип локи|список переходов
    'd' => 'Северная улица|1|к северным воротам|x1029x450|на восток|x1082x474|на юг|x1039x492|на запад|x1017x471',
    // список объектов - персонажей, NPC, предметов
    'i' => [
        // предметы(стационарные и брошенные)
        "i.s.rudnik" => "рудная жила|8|0|300|8|1",
        "i.s.res" => "камень воскрешения||0",
        // NPC notes/npc-info.md
        'n.npcid' => [],
        // персонажи notes/user-info.md
        'u.username' => []
    ],
    // список таймеров: "время респа" => "id|resp_min:resp_max|move_num:time_min:time_max"
    // таймер удаляется при срабатывании
    't' => [
        1 => 'n.guildmaster|1:2',
        2 => 'n.Den|1:2',
        9 => 'n.a.dog.walk|300:600|10:10:30'
    ]
]
```
## Описание локации(d): `$d = explode('|', $loc_tt[$loc]['d'])`

* тип: строка
* разделитель значений: `|`
* содержит название и тип локации
* дополнительно может содержать список переходов в соседние локации

```php
//        0      |1|         2        |    3    |    4    |    5    |  6  |    7    |   8    |    9
// Северная улица|1|к северным воротам|x1029x450|на восток|x1082x474|на юг|x1039x492|на запад|x1017x471
$d[0] - $title // строка, название локации
$d[1] - $type  // число, тип територии
// для $i >= 2 // список переходов
$d[  $i  ] - $title // строка, название локации
$d[$i + 1] - $id    // строка, ID локации
```
### Виды локаций

вид локации определяет ее ID
* обычные: ID в формате `implode('x', ['', X, Y])`, где `X` и `Y` - координаты
* Замковые: ID в формате `c.N.ID`, где `N` - номер замка(1-5), а `ID`
    * `in` - перед замковыми воротами
    * `gate` - внутренний двор, поле `$title` имеет специальное значение и обрабатывается отдельно 
    * `main` - главный зал
    * `sklad` - склад/кладовая
    * `tron` - тронный зал
* специальные: ID - в свободной форме. В исходниках есть несколько таких:
    * `_begin` - начальная локация. в нее помещается персонаж после регистации.
    * `_begi` - есть упоминание, но нет переходов до этого места.
        до конца не понятно, зачем оно, нужно разобраться.
        Возможно, просто недоделанный участок територии.
    * `arena` - арена смерти
    * `qv` - локация для подготовки к эвентам, по идее должно быть доступно только админам

Некоторые "обычные" требуют специальной обработки. Например:
    * комнаты в таверне требуют ключи и при выходе из игры выкидывает в коридор
    * на корабли нельзя подниматься с "флагом"
    * несколько локаций, на которые "не пускает стража"

### Типы територий

* 0 - нейтральная(?)
* 1 - безопасная(?), в файлах некоторых локаций по ошибке выставлено `l` - `L` маленькая
* 2 - територия тамплиеров
* 3 - територия пиратов

## Список объектов(i): `$i = $loc_tt[$loc]['i'];`

* тип: ассоциативный массив
* содержит список объектов
* ключ является ID объекта, по которому определяется его тип
    * `i.*` - строка, предметы. могут быть как постоянными, так и временными
    * `n.*` - массив, NPC
    * `u.*` - массив, игроки

## Список таймеров(t): `$t = $loc_tt[$loc]['t'];`

* тип: ассоциативный массив
* содержит список таймеров
* используется для респа НПС и предметов.
* в ключе содержится время срабатывения таймера
* значение является строкой и содержит описание таймера
    * `i.*` - предметы
    * `n.*` - NPC
    * другие обрабатываются через `eval`
* после срабатывания таймер удаляется из списка
