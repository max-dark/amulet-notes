# Структура "Локация"

## Описания форматов данных в переменных

Локация - это ассоциативный массив, содержащий её описание, списки таймеров и объектов

ID текущей локации обычно хранится в глобальной переменной `$loc`

Локация может иметь текстовое описание в файле `loc_f/$loc`

В движке используется три глобальных массива с локациями:
* `$loc_tt[]` - список загруженных локаций
* `$loc_t[$loc]` - таймеры. берется из `$loc_tt[$loc]['t']`
* `$loc_i[$loc]` - объекты(игроки, НПС и предметы). берется из `$loc_tt[$loc]['i']`

Иногда используется четвертый - `$loc_c` - описание и список переходов. берется из `$loc_tt[$loc]['d']`

### поля структуры

* `d` - строка, содержит название, тип територии и список переходов в соседние
* `i` - массив, список объектов
* `t` - массив, список таймеров

```php
// пример структуры $loc_tt[$loc]
[
    // название локации|тип локи|список переходов
    'd' => 'Северная улица|1|к северным воротам|x1029x450|на восток|x1082x474|на юг|x1039x492|на запад|x1017x471',
    // список объектов - персонажей, NPC, предметов
    'i' => [
        // предметы(стационарные и брошенные)
        "i.s.rudnik" => "рудная жила|8|0|300|8|1",
        "i.s.res" => "камень воскрешения||0",
        // NPC
        'n.npcid' => [],
        // персонажи
        'u.username' => []
    ],
    // список таймеров: "время респа" => "id|resp_min:resp_max|move_num:time_min:time_max"
    't' => [
        1 => 'n.guildmaster|1:2',
        2 => 'n.Den|1:2',
        9 => 'n.a.dog.walk|300:600|10:10:30'
    ]
]
```
## Описание локации(d): `$d = explode('|', $loc_tt[$loc]['d'])`

* тип: строка
* разделитель значений: `|`
* содержит название и тип локации
* дополнительно может содержать список переходов в соседние локации

```php
//        0      |1|         2        |    3    |    4    |    5    |  6  |    7    |   8    |    9
// Северная улица|1|к северным воротам|x1029x450|на восток|x1082x474|на юг|x1039x492|на запад|x1017x471
$d[0] - $title // строка, название локации
$d[1] - $type  // число, тип територии
// список переходов
for($i = 2; $i < count($d); $i += 2) {
    $d[  $i  ] - $title // строка, название локации
    $d[$i + 1] - $id    // строка, ID локации
}
```
### Виды локаций

вид локации определяет ее ID
* обычные: ID в формате `implode('x', ['', X, Y])`, где `X` и `Y` - координаты
* Замковые: ID в формате `implode('.', ['c', N, ID])`, где `N` - номер замка(1-5), а `ID`
    * `in` - перед замковыми воротами
    * `gate` - внутренний двор, поле `$title` имеет специальное значение и обрабатывается отдельно 
    * `main` - главный зал
    * `sklad` - склад/кладовая
    * `tron` - тронный зал
* специальные: ID - в свободной форме. В исходниках есть несколько таких:
    * `_begin` - начальная локация. в нее помещается персонаж после регистации.
    * `_begi` - есть упоминание, но нет переходов до этого места.
        до конца не понятно, зачем оно, нужно разобраться.
        Возможно, просто недоделанный участок територии.
    * `arena` - арена смерти
    * `qv` - локация для подготовки к эвентам, по идее должно быть доступно только админам

Некоторые "обычные" требуют специальной обработки. Например:
    * комнаты в таверне требуют ключи и при выходе из игры персонажа выкидывает в коридор
    * на корабли нельзя подниматься с "флагом"
    * несколько локаций, на которые "не пускает стража"

### Типы територий

* 0 - нейтральная(?)
* 1 - охраняемая(?), в файлах некоторых локаций по ошибке выставлено `l` - `L` маленькая
* 2 - територия тамплиеров
* 3 - територия пиратов

## Список объектов(i): `$i = $loc_tt[$loc]['i'];`

* тип: ассоциативный массив
* содержит список объектов
* ключ является ID объекта, по которому определяется тип его значения
    * `i.*` - строка, предметы.
    * `n.*` - массив, [NPC](npc.md)
    * `u.*` - массив, [игроки](user.md)

### Предметы в локации

Предметы могут быть как постоянными, так и временными.

```php
$itemInfo = explode('|', $loc_tt[$loc]['i'][$itemId]);
```
#### Общие поля:
* 0 - строка, название
* 2 - таймер, время удаления предмета. для "постоянных" равняется `0`

#### Поля для "обычных" предметов:
* 1 - число, количество предметов

#### Для "трупов":
* 1 - флаг, что сбор предметов не будет преступлением. 0 или 1
* 2 - таймер, время исчезновения(время убийства + период, указанный в настройках)
* 3 - строка, список предметов из рюкзака. разделитель - `,`(запятая)
* 4 - строка. список предметов при освежевании. разделитель - `,`(запятая)

#### "Источники ресурсов"

Реализовано 2 вида - деревья(`i.s.tree`) и рудники(`i.s.rudnik`)

* 0 - название источника ресурса("Дерево", "Рудник")
* 1 - текущее количество ресурса.
* 3 - период обновления после исчерпания ресурса.
* 4 - количество ресурса при обновлении.
* 5 - таймер обновления ресурсов. устанавливается после исчерпания.

## Список таймеров(t)

`$t = $loc_tt[$loc]['t'];`

* тип: ассоциативный массив
* содержит список таймеров
* используется для респа НПС и предметов.
* в ключе содержится время срабатывания таймера
* значение содержит [описание таймера](location-timers.md)
    * строка `i.*` - предметы
    * массив либо строка `n.*` - NPC
    * другие обрабатываются через `eval`
* после срабатывания:
    * для предметов таймер переустанавливается.
    * для NPC таймер удаляется и устанавливается при смерти NPC.
